{% extends 'def_i/base.html' %}
{% load static sass_tags %}
{% block extra_style %}
<link rel="stylesheet" href="{% sass_src 'def_i/css/article_detail.scss' %}">
<link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock extra_style %}

{% block menubar %}{% endblock menubar %}

{% block contents %}
{% if user == contents.poster %}
    <span><a href="{% url 'question_edit' contents.pk %}">編集する</a></span>
    <span><a href="{% url 'question_delete' contents.pk %}">削除する</a></span>
{% endif %}

<div id="question">

    <h1>{{contents.title}}</h1>
    <div class="like-outer">
        {% include 'def_i/bookmark.html' %}
    </div>

    <p>{{contents.category}}</p>
    <p>レッスン{{contents.course.course_num}}-{{contents.lesson.lesson_num}}</p>
    <span>{{contents.created_at|date:"Y/M/j H:i"}}</span>
    <div class="article-contents">{{contents.formatted_markdown|safe}}</div>
    {% if contents.question_image_1 %}
    <img src="{{ contents.question_image_1_resize.url }}" alt="">
    {% endif %}
    {% if contents.question_image_2 %}
    <img src="{{ contents.question_image_2_resize.url }}" alt="">
    {% endif %}
</div>

<p id="answers">回答</p>
{% for c in comments %}
<article class="main-container__contents-article">
    <a href="{% url 'user_page' c.msg_from.pk %}">
        <img src="{{c.msg_from.user_image.url}}" width="30" alt="">
        <p>{{c.msg_from}}></p>
    </a>
    <p>{{c.time|date:"Y/M/j H:i"}}</p>
    <h1>{{c.msg}}</h1>
</article>
{% empty %}
<p>コメントがありません．</p>
{% endfor %}

<form method="POST">
    {% csrf_token %}
    {{form.msg}}
    <button type='submit'>送信</button>
</form>
<a href="{% url 'question_feed' %}?orderby=new"><p>質問フィードに戻る</p></a>

<!-- サイドバー -->
<p>投稿者：{{contents.poster}}</p>
<ul>
    <li id="to_question">質問</li>
    <li id="to_answer">回答</li>
</ul>

<h2>関連した質問</h2>
{% for question in related_questions %}
    <p><a href="{% url 'question_detail' question.pk %}">{{question.title|truncatechars:40}}</a></p>
{% endfor %}
{% endblock contents %}

{% block javascript %}
<script>
    //jQueryあんまりよくないと知る前に作ったので使っています．．．
    $(document).ready(function (e) {
        $(document).on('click', '#bookmark', function (e) {
            e.preventDefault(); //button&POSTに対しては効きません．．．．
            $.ajax({
                type: 'GET',
                url: "{% url 'bookmark' contents.pk %}",
                success: function (response) {
                    heartMark = document.getElementById('bookmark')
                    if (response.bookmarked) {
                        $(heartMark).html("<i class='fas fa-lg fa-heart'></i>")
                    }
                    else {
                        $(heartMark).html("<i class='far fa-lg fa-heart'></i>")
                    }
                    likeCount = document.getElementById('count')
                    $(likeCount).text(response.bookmark_count)
                }
            })
        })
    })


    document.getElementById("to_question").addEventListener('click', function(){
        const question = document.getElementById("question");
        const question_position = question.getBoundingClientRect();
        window.scrollTo(0, question_position.top);
    });

    document.getElementById("to_answer").addEventListener('click', function(){
        console.log('0');
        const answers = document.getElementById("answers");
        console.log('answers:' + answers);
        const answers_position = answers.getBoundingClientRect();
        console.log('answers_posi:' + answers_position);
        window.scrollTo(0, answers_position.top);
    });
</script>
{% endblock javascript %}
